rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(ownerId) {
      return request.auth.uid == ownerId;
    }
    
    // Prayers collection
    match /prayers/{prayerId} {
      // Allow authenticated users to read their own prayers
      allow read: if isAuthenticated() && isOwner(resource.data.ownerId);
      
      // Allow authenticated users to create prayers (they must set themselves as owner)
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      
      // Allow users to update and delete their own prayers
      allow update, delete: if isAuthenticated() && isOwner(resource.data.ownerId);
    }
    
    // Groups collection
    match /groups/{groupId} {
      // Allow authenticated users to read groups they are members of
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.members;
      
      // Allow authenticated users to create groups (they must add themselves as admin and member)
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.admins &&
                       request.auth.uid in request.resource.data.members;
      
      // Allow group admins to update the group
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.admins;
      
      // Allow group admins to delete the group
      allow delete: if isAuthenticated() && 
                       request.auth.uid in resource.data.admins;
    }
    
    // Prayer Updates subcollection
    match /prayers/{prayerId}/updates/{updateId} {
      // Helper to get the parent prayer
      function getPrayer() {
        return get(/databases/$(database)/documents/prayers/$(prayerId)).data;
      }
      
      // Helper to check if user can access the prayer
      function canAccessPrayer() {
        return isAuthenticated() && 
               (getPrayer().ownerId == request.auth.uid ||
                request.auth.uid in getPrayer().sharedWith);
      }
      
      // Allow reading updates if user can read the parent prayer
      allow read: if canAccessPrayer();
      
      // Allow creating updates if user can read the prayer
      allow create: if isAuthenticated() && 
                       canAccessPrayer() &&
                       request.resource.data.authorId == request.auth.uid;
      
      // Allow updating/deleting own updates
      allow update, delete: if isAuthenticated() && 
                               resource.data.authorId == request.auth.uid;
    }
  }
}
