rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper to check if user owns the resource
    function isOwner(ownerId) {
      return request.auth.uid == ownerId;
    }

    // Helper to get user's groups
    function getUserGroups() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.groups;
    }

    // Helper to check if prayer is shared with any of user's groups
    function isSharedWithUser(sharedWith) {
      return isAuthenticated() && 
             sharedWith.hasAny(getUserGroups());
    }
    
    // Users collection to track user metadata and group memberships
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(userId);
    }

    // Prayers collection
    match /prayers/{prayerId} {
      // Allow authenticated users to read their own prayers OR prayers shared with their groups
      allow read: if isAuthenticated() && (isOwner(resource.data.ownerId) || isSharedWithUser(resource.data.sharedWith));
      
      // Allow authenticated users to create prayers (they must set themselves as owner)
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      
      // Allow users to update and delete their own prayers
      allow update, delete: if isAuthenticated() && isOwner(resource.data.ownerId);
    }
    
    // Groups collection
    match /groups/{groupId} {
      // Allow authenticated users to read groups (necessary for invite/join flow)
      allow read: if isAuthenticated();
      
      // Allow authenticated users to create groups (they must add themselves as admin and member)
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.admins &&
                       request.auth.uid in request.resource.data.members;
      
      // Allow group members to update the group (e.g. joining)
      // Actually strictly, only admins should change name/description, but members can add themselves?
      // Usually joining is a specific logic.
      allow update: if isAuthenticated() && (
                       request.auth.uid in resource.data.admins ||
                       (request.auth.uid in request.resource.data.members && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']))
                    );
      
      // Allow group admins to delete the group
      allow delete: if isAuthenticated() && 
                       request.auth.uid in resource.data.admins;
    }
    
    // Prayer Updates subcollection
    match /prayers/{prayerId}/updates/{updateId} {
      // Helper to get the parent prayer data
      function getPrayerData() {
        return get(/databases/$(database)/documents/prayers/$(prayerId)).data;
      }
      
      // Allow reading updates if user can read the parent prayer
      allow read: if isAuthenticated() && (
                     isOwner(getPrayerData().ownerId) || 
                     isSharedWithUser(getPrayerData().sharedWith)
                  );
      
      // Allow creating updates if user is the owner of the prayer
      allow create: if isAuthenticated() && 
                       isOwner(getPrayerData().ownerId) &&
                       request.resource.data.authorId == request.auth.uid;
      
      // Allow updating/deleting own updates
      allow update, delete: if isAuthenticated() && 
                                resource.data.authorId == request.auth.uid;
    }
  }
}
